console.log("DIRNAME DO SEED:", __dirname);

const path = require("path");
const bcrypt = require("bcryptjs");
const mongoose = require("mongoose");

const dotEnvPath = path.resolve(__dirname, "../../../.env");
require("dotenv").config({ path: dotEnvPath });

const User = require("../../app/models/User");
const Job = require("../../app/models/Job");

if (process.env.NODE_ENV === "production") {
  console.error("âŒ NÃ£o Ã© permitido rodar o seed em produÃ§Ã£o.");
  process.exit(1);
}

async function createDemoUser() {
  const hashedPassword = await bcrypt.hash("123456", 10);
  return User.create({
    email: "demo@demo.com",
    password: hashedPassword,
    name: "Demo User",
    profile: {
      name: "Demo User",
      preferences: { theme: "light", notifications: true },
    },
  });
}

async function createJobsForUser(userId) {
  await Job.create([
    {
      title: "Frontend Developer",
      description: "React dev",
      company: "Acme",
      salary: 3000,
      tags: ["react", "frontend"],
      owner: userId,
    },
    {
      title: "Backend Developer",
      description: "Node.js dev",
      company: "Acme",
      salary: 4000,
      tags: ["node", "backend"],
      owner: userId,
    },
  ]);
}

(async () => {
  if (!process.env.MONGO_URI) {
    console.error("âŒ ERRO: MONGO_URI nÃ£o definida no .env.");
    process.exit(1);
  }

  try {
    console.log("ğŸ”„ Conectando ao MongoDB...");
    await mongoose.connect(process.env.MONGO_URI);
    console.log("âœ… ConexÃ£o estabelecida.");

    console.log("ğŸ”„ Limpando coleÃ§Ãµes...");
    await User.deleteMany({});
    await Job.deleteMany({});
    console.log("âœ… ColeÃ§Ãµes limpas.");

    console.log("ğŸ”„ Criando usuÃ¡rio demo...");
    const u = await createDemoUser();
    console.log(`âœ… UsuÃ¡rio criado: ${u.email}`);

    console.log("ğŸ”„ Criando empregos...");
    await createJobsForUser(u._id);
    console.log("âœ… Empregos criados.");

    console.log("âœ… Seed completo.");
  } catch (err) {
    console.error("âŒ Erro ao rodar o seed:", err.message);
  } finally {
    await mongoose.disconnect();
    process.exit(0);
  }
})();
